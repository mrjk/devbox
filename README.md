# MrJK's DevBox

MrJK's devbox attempt to provide a local and generic services to allow you to deploy other stacks. This stack is particulary useful if you have to work on different app environments on different DNS domains, when you want to expose a local service on a clean HTTPS or when you have to deal with many services listening the same port.

This docker-compose stack provides two services:
* Authoritative DNS server (Dnsmasq)
* HTTP proxy with HTTPS support (Traefik)
* Docker web UI (Portainer)

This is a simple devbox, it does not configure you local workstation. This project is only relevant for local resolution, it's not a network setup. This docker-compose will not work in swarm mode.


Under the hood:

1. Use Docker Compose to manage everything cleanly
2. Run Traefik in Docker configured to use Docker as a backend
3. Run dnsmasq in Docker to resolve a nice tld to a local ip
4. Configure your system to use dnsmasq for DNS lookup
    + If Mac: Don't forget to add a fallback dns in the Mac system preferences, 
      otherwise when docker restarts you won't be able to access the internet
5. (Optional) Run Portainer to make inspecting Docker easier

## Requirements

To make everything work you will need:

* At least one available network interface
  * Use case: Allow you to have many Traefik instances listening on port 80
  * You can use localhost by default
  * You will need to add more interfaces if you want to have many listening services
    * This allow other services in docker environment to query those services
    * See howto in this documentation
* Split DNS setup
  * Use cases: Allow to resolve locally domains to the correct Traefik instance
  * You may want to configure Network Manager with dnsmasq
    * See howto in this documentation
  * You may want to use systemd-resolved (todo)


## Quickstart

Check the box configuration:
```
cp .env .env.example
vim .env
```

Edit the config:
```
TOP_DOMAIN=.box
PUBLIC_IP=127.0.0.1
```

Check the configuration for the DNS resolution:
```
$ vim config/dnsmasq.conf
```

For example, direct record config:
```
# Default box config
address=/.box/127.0.0.1

# Another domain to forward to another proxy
address=/.dev/10.127.0.2
```


Check the configuration for the proxy configuration, you may never have to edit this file:
```
$ vim config/traefik/dyn.yml
```

Apply changes:
```
$ docker-compose up -d
```

Then you can go to:
* http://portainer.box/
* http://dns.box/
* http://traefik.box/

To restart stack:
```
docker-compose down ; docker-compose rm ; docker-compose up -d
```

## System configuration

The host setup configuration is needed:
* To solve the split DNS problem, which consists on fixing system DNS resolution
* To solve the multiple apps listening the same port, which consists on creating fake IP locally

### Network-manager setup: with localhost
TODO

### Network-manager setup: with bridge
TODO

### Dumb hack

Update your local resolver
```
cat /etc/resolv.conf
# Generated by NetworkManager
nameserver ${PUBLIC_IP}
```

### Network Manager and dnsmasq

TODO




## Examples configuration

Configuration happens in those two files:
```
$ head -n 999  config/dnsmasq.conf  config/traefik/dyn.yml 
==> config/dnsmasq.conf <==

log-queries
no-resolv
no-hosts

# Keep this disable to use system resolvers
#server=1.0.0.1
#server=1.1.1.1

conf-dir=/etc/dnsmasq.d,*.conf

strict-order

address=/.box/10.127.0.2
address=/.dev/10.127.0.2

==> config/traefik/dyn.yml <==
## Dynamic configuration
http:
  routers:
    wildcard-cert:
      rule: "Host(`toto.box`)"
      entrypoints:
        - web
        #- front-http
        #- front-https
      #tls:
      #  certresolver:
      #  domains:
      #    - main: example.com
      #      sans: "*.example.com"
      service: forward-local-1313

  services:
    forward-local-1313:
      loadBalancer:
        servers:
          - url: 'http://10.127.0.10:1313'


  middlewares:
    https-redirect:
      redirectScheme:
        scheme: https
```


## Project state

This project is a fork of https://github.com/petercoulton/devbox

### Known issues

* I was not able to use Traefik for proxying DNS traffic
  * So dnsmasq directly exposes its ports to Docker


### TODO

+ [x] Add todo list
+ [ ] Add ssl
+ [ ] Capture access logs

### Bibliography

+ https://medium.com/@williamhayes/local-dev-on-docker-fun-with-dns-85ca7d701f0a
+ https://www.stevenrombauts.be/2018/01/use-dnsmasq-instead-of-etc-hosts/
+ https://github.com/portainer/portainer-compose/
+ https://github.com/jpillora/docker-dnsmasq
  + Uses [webproc](https://github.com/jpillora/webproc) to make 
    the `dnsmasq` config editable via a web app.
+ https://blog.agchapman.com/using-variables-in-docker-compose-files/

### Other interesting links

+ [Dinghy](https://github.com/codekitchen/dinghy)
  + An older project with a cli tool for managing project

+ List of raw ideas:
  + https://github.com/inetum-orleans/docker-devbox


## License

GPL-v3
